<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OCR Video Analysis</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .video-box { flex: 2; position: relative; }
        .transcript-box { flex: 1; height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        .segment { padding: 5px; cursor: pointer; border-bottom: 1px solid #eee; }
        .segment:hover { background-color: #f0f0f0; }
        .active { background-color: #e0f7fa; border-left: 4px solid #00bcd4; }
        #overlay { 
            position: absolute; bottom: 10%; left: 5%; right: 5%; 
            background: rgba(0,0,0,0.7); color: white; padding: 10px; 
            text-align: center; display: none; pointer-events: none;
        }
        video { width: 100%; }
        .controls { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; }
    </style>
</head>
<body>

    <h1>OCR Video Pipeline</h1>

    <div class="controls">
        <input type="file" id="videoInput" accept="video/mp4">
        <button onclick="uploadVideo()">Process Video</button>
        <span id="status"></span>
        <br><br>
        <input type="text" id="searchBox" placeholder="Search transcript..." onkeyup="filterTranscript()">
        <button id="downloadBtn" style="display:none;" onclick="downloadExcel()">Download Excel</button>
    </div>

    <div class="container">
        <div class="video-box">
            <video id="mainVideo" controls></video>
            <div id="overlay"></div>
        </div>
        <div class="transcript-box" id="transcript">
            <p>Upload a video to see transcript here.</p>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let transcriptData = [];

        async function uploadVideo() {
            const fileInput = document.getElementById('videoInput');
            const file = fileInput.files[0];
            if (!file) return alert("Select a file first");

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById('status').innerText = "Uploading...";
            
            const res = await fetch('/api/process', { method: 'POST', body: formData });
            const data = await res.json();
            currentTaskId = data.task_id;
            
            // Set video source locally so user can watch while processing
            const vidUrl = URL.createObjectURL(file);
            document.getElementById('mainVideo').src = vidUrl;

            pollStatus();
        }

        function pollStatus() {
            const interval = setInterval(async () => {
                const res = await fetch(`/api/status/${currentTaskId}`);
                const data = await res.json();
                document.getElementById('status').innerText = `Status: ${data.status}`;

                if (data.status === 'completed') {
                    clearInterval(interval);
                    loadTranscript();
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                }
            }, 2000);
        }

        async function loadTranscript() {
            const res = await fetch(`/api/transcript/${currentTaskId}`);
            const data = await res.json();
            transcriptData = data.segments;
            renderTranscript(transcriptData);
        }

        function renderTranscript(segments) {
            const container = document.getElementById('transcript');
            container.innerHTML = "";
            segments.forEach(seg => {
                const div = document.createElement('div');
                div.className = 'segment';
                div.innerHTML = `<b>${formatTime(seg.start_ts)}</b>: ${seg.text}`;
                div.onclick = () => seekVideo(seg.start_ts);
                div.dataset.start = seg.start_ts;
                div.dataset.end = seg.end_ts;
                container.appendChild(div);
            });
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            return new Date(s * 1000).toISOString().substr(14, 5);
        }

        function seekVideo(ms) {
            const video = document.getElementById('mainVideo');
            video.currentTime = ms / 1000;
            video.play();
        }
        
        function downloadExcel() {
            window.location.href = `/api/report/excel?task_id=${currentTaskId}`;
        }

        function filterTranscript() {
            const q = document.getElementById('searchBox').value.toLowerCase();
            const filtered = transcriptData.filter(s => s.text.toLowerCase().includes(q));
            renderTranscript(filtered);
        }

        // Overlay Logic
        const video = document.getElementById('mainVideo');
        const overlay = document.getElementById('overlay');

        video.ontimeupdate = () => {
            const now = video.currentTime * 1000;
            const currentSeg = transcriptData.find(s => now >= s.start_ts && now <= s.end_ts);
            
            // Highlight list item
            document.querySelectorAll('.segment').forEach(div => {
                div.classList.remove('active');
                if (currentSeg && div.dataset.start == currentSeg.start_ts) {
                    div.classList.add('active');
                    div.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            });

            // Show overlay
            if (currentSeg) {
                overlay.innerText = currentSeg.text;
                overlay.style.display = 'block';
            } else {
                overlay.style.display = 'none';
            }
        };
    </script>
</body>
</html>